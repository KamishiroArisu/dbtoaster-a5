The following code corresponds to query 4
\begin{footnotesize}
\begin{verbatim}
create table `shipping_params' as
  select 
    avg   (l_shipdate    - o_orderdate) AS ship_mu,
    AVG   (l_receiptdate - l_shipdate ) AS arrv_mu,
    stddev(l_shipdate    - o_orderdate) AS ship_sigma,
    stddev(l_receiptdate - l_shipdate ) AS arrv_sigma,
    l_partkey AS p_partkey
  from orders,lineitem
  where o_orderkey = l_orderkey
  group by partkey;
alter table params add constraint "p_partkey_pkey" 
  primary key (p_partkey);
-- BEGIN TIMING QUERY --
create temporary table q4_shipping_times as
  select
    o_orderkey AS orderkey,
    o_custkey AS custkey,
    CREATE VARIABLE(`Normal',ship_mu,ship_sigma)
    CREATE VARIABLE(`Normal',arrv_mu,arrv_sigma)
  from  orders,lineitem,shipping_params
  where p_partkey = l_partkey;
   and  o_orderdate = today()
   and  o_orderkey  = l_orderkey;

create temporary table q4_annoyed_customers as
  select custkey
  from   q4_shipping_times
  where  ship > 120
union all
  select custkey
  from   q4_shipping_times
  where  arrv > 90;

create temporary table q4_order_increase as
  select o_orderkey, o_custkey,
         CREATE VARIABLE(`Poisson', increase) *
           l_extended_price * (1.0 - l_discount) as rev
  from
   (select newcount / oldcount as increase, custkey 
    from
     (select o_custkey as custkey, 
             sum(extract(year from o_orderdate)
                 -1996.0) AS newcount,
             sum(1997.0-extract(year from 
                 o_orderdate)) AS oldcount
      where  extract(year from o_orderdate) = 1997
        or   extract(year from o_orderdate) = 1996
      group by custkey
     ) as counts
   ) as increase_per_cust,
    orders
  where custkey = o_custkey
 ) as var_increase_per_customer,
 (select lineitem.*,
  from   nation,supplier, lineitem, partsupp
  where  n_name = 'japan' and n_nationkey = s_nationkey
   and   s_suppkey = ps_suppkey
   and   ps_partkey = l_partkey
   and   ps_suppkey = l_suppkey
 ) as items_from_japan;
-- BEGIN TIMING SAMPLE --
select avg(confidence),
       expect_sum_naive(rev, q4_annoyed_customers)
from   q4_annoyed_customers,
       (select o_custkey as custkey, rev
        from   q4_revenue_gains
       ) as revenues
where  revenues.custkey = q4_annoyed_customers.custkey;






\end{verbatim}
\end{footnotesize}