open Util
open K3OCamlgen
open K3
open K3.SR

;;

let tcode ?(t=K3O.Float) txt = (IP.Leaf("<<"^txt^">>"),t);;
let code_list = List.map tcode ["x";"y";"z"];;
let arg_list = List.map (fun x -> ("<<"^x^">>",K3.SR.TFloat)) ["x";"y";"z"];;

module K3OC = K3Compiler.Make(K3OCamlgen.K3CG)

;;

let test_compile = DBTDebug.k3_test_compile

;;

let run_test ?(extractor = (fun x -> x)) (name:string) (test:K3.SR.expr_t) 
             (result:string) =
   Debug.log_unit_test
      ("K3 Ocaml RST "^name) 
      (fun x -> x)
      (extractor (K3CG.debug_string (K3OC.compile_k3_expr test)))
      result

;;

let run_test_type =
   run_test ~extractor:(fun x -> String.sub x 0 (String.index x ':'))

;;

let slice_t = (K3.SR.Slice((K3.SR.OutPC("QUERY_1_1R1T1",[ "QUERY_1_1R_R__B",(K3.SR.TFloat); "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ "QUERY_1_1R_R__B",(K3.SR.TFloat); "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat) ],([ "QUERY_1_1R1S1T_T__C",(K3.SR.Var("QUERY_1_1R1S1T_T__C",(K3.SR.TFloat))) ])))
in
   run_test "on_insert_t_slice" slice_t 
      "dbentry_map( [float, float] -> float): MC.slice ([ 1 ]) ([(var_QUERY_1_1R1S1T_T__C)]) (DB.get_out_map \"QUERY_1_1R1T1\" dbtoaster_db)"

;;

let gbq_t = (K3.SR.GroupByAggregate((K3.SR.AssocLambda(K3.SR.ATuple([ "QUERY_1_1R_R__B",(K3.SR.TFloat); "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat); "v2",(K3.SR.TFloat) ]),K3.SR.AVar("accv",(K3.SR.TFloat)),(K3.SR.Add((K3.SR.Mult((K3.SR.Var("QUERY_1_1R1S1T_D",(K3.SR.TFloat))),(K3.SR.Var("v2",(K3.SR.TFloat))))),(K3.SR.Var("accv",(K3.SR.TFloat))))))),(K3.SR.Const(M3.CFloat(0.))),(K3.SR.Lambda(K3.SR.ATuple([ "QUERY_1_1R_R__B",(K3.SR.TFloat); "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat); "v2",(K3.SR.TFloat) ]),(K3.SR.Tuple([ (K3.SR.Var("QUERY_1_1R_R__B",(K3.SR.TFloat))) ])))),(K3.SR.Slice((K3.SR.OutPC("QUERY_1_1R1T1",[ "QUERY_1_1R_R__B",(K3.SR.TFloat); "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ "QUERY_1_1R_R__B",(K3.SR.TFloat); "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat) ],([ "QUERY_1_1R1S1T_T__C",(K3.SR.Var("QUERY_1_1R1S1T_T__C",(K3.SR.TFloat))) ])))))
in
   test_compile 
      "on_insert_t_gbq" ["QUERY_1_1R1S1T_T__C";"QUERY_1_1R1S1T_D"]
      gbq_t
;;

let else_t = (K3.SR.PCValueUpdate((K3.SR.SingletonPC("QUERY_1_1",(K3.SR.TFloat))),[  ],[  ],(K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("current_v",(K3.SR.TFloat)),(K3.SR.Add((K3.SR.Var("current_v",(K3.SR.TFloat))),(K3.SR.Mult((K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("init_val",(K3.SR.TFloat)),(K3.SR.Block([ (K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1T1",[ "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R1S1T_T__C",(K3.SR.TFloat))) ],(K3.SR.Var("init_val",(K3.SR.TFloat))))); (K3.SR.Var("init_val",(K3.SR.TFloat))) ])))),(K3.SR.Const(M3.CFloat(0.))))),(K3.SR.Var("QUERY_1_1R1S1T_D",(K3.SR.TFloat))))))))),(K3.SR.SingletonPC("QUERY_1_1",(K3.SR.TFloat)))))))
in
   test_compile
      "on_insert_t_else" ["QUERY_1_1R1S1T_T__C";"QUERY_1_1R1S1T_D"]
      else_t

;;

let step_2 = (K3.SR.AssocLambda(K3.SR.ATuple([ "QUERY_1_1R_R__B",(K3.SR.TFloat); "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat); "v2",(K3.SR.TFloat) ]),K3.SR.AVar("accv",(K3.SR.TFloat)),(K3.SR.Add((K3.SR.Mult((K3.SR.Var("QUERY_1_1R1S1T_D",(K3.SR.TFloat))),(K3.SR.Var("v2",(K3.SR.TFloat))))),(K3.SR.Var("accv",(K3.SR.TFloat)))))))
in
   run_test_type
      "on_insert_t_assoc_lambda"
      step_2
      "fn([float, float, float], float -> float)"

;;

let step_2 = (K3.SR.Lambda(K3.SR.ATuple([ "QUERY_1_1R_R__B",(K3.SR.TFloat); "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat); "v2",(K3.SR.TFloat) ]),(K3.SR.Tuple([ (K3.SR.Var("QUERY_1_1R_R__B",(K3.SR.TFloat))) ]))))
in
   run_test_type
      "on_insert_t_lambda"
      step_2
      "fn([float, float, float] -> [float])"

;;

let step_2 = (K3.SR.Slice((K3.SR.OutPC("QUERY_1_1R1T1",[ "QUERY_1_1R_R__B",(K3.SR.TFloat); "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ "QUERY_1_1R_R__B",(K3.SR.TFloat); "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat) ],([ "QUERY_1_1R1S1T_T__C",(K3.SR.Var("QUERY_1_1R1S1T_T__C",(K3.SR.TFloat))) ])))
in
   run_test_type
      "on_insert_t_slice"
      step_2
      "dbentry_map( [float, float] -> float)"

;;

let step_2 = (K3.SR.GroupByAggregate((K3.SR.AssocLambda(K3.SR.ATuple([ "QUERY_1_1R_R__B",(K3.SR.TFloat); "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat); "v2",(K3.SR.TFloat) ]),K3.SR.AVar("accv",(K3.SR.TFloat)),(K3.SR.Add((K3.SR.Mult((K3.SR.Var("QUERY_1_1R1S1T_D",(K3.SR.TFloat))),(K3.SR.Var("v2",(K3.SR.TFloat))))),(K3.SR.Var("accv",(K3.SR.TFloat))))))),(K3.SR.Const(M3.CFloat(0.))),(K3.SR.Lambda(K3.SR.ATuple([ "QUERY_1_1R_R__B",(K3.SR.TFloat); "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat); "v2",(K3.SR.TFloat) ]),(K3.SR.Tuple([ (K3.SR.Var("QUERY_1_1R_R__B",(K3.SR.TFloat))) ])))),(K3.SR.Slice((K3.SR.OutPC("QUERY_1_1R1T1",[ "QUERY_1_1R_R__B",(K3.SR.TFloat); "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ "QUERY_1_1R_R__B",(K3.SR.TFloat); "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat) ],([ "QUERY_1_1R1S1T_T__C",(K3.SR.Var("QUERY_1_1R1S1T_T__C",(K3.SR.TFloat))) ])))))
in
   run_test_type
      "on_insert_t_step_2_gather_1"
      step_2
      "dbentry_map( [float] -> float)"

;;

let step_2 = (K3.SR.Lambda(K3.SR.ATuple([ "QUERY_1_1R_R__B",(K3.SR.TFloat); "dv",(K3.SR.TFloat) ]),(K3.SR.IfThenElse((K3.SR.Member((K3.SR.OutPC("QUERY_1_1R1",[ "QUERY_1_1R_R__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R_R__B",(K3.SR.TFloat))) ])),(K3.SR.Tuple([ (K3.SR.Var("QUERY_1_1R_R__B",(K3.SR.TFloat))); (K3.SR.Add((K3.SR.Lookup((K3.SR.OutPC("QUERY_1_1R1",[ "QUERY_1_1R_R__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R_R__B",(K3.SR.TFloat))) ])),(K3.SR.Var("dv",(K3.SR.TFloat))))) ])),(K3.SR.Tuple([ (K3.SR.Var("QUERY_1_1R_R__B",(K3.SR.TFloat))); (K3.SR.Add((K3.SR.Const(M3.CFloat(0.))),(K3.SR.Var("dv",(K3.SR.TFloat))))) ]))))))
in
   run_test_type
      "on_insert_t_step_2_map_lambda"
      step_2
      "fn([float, float] -> [float, float])"
      

;;

let step_2 = (K3.SR.Map((K3.SR.Lambda(K3.SR.ATuple([ "QUERY_1_1R_R__B",(K3.SR.TFloat); "dv",(K3.SR.TFloat) ]),(K3.SR.IfThenElse((K3.SR.Member((K3.SR.OutPC("QUERY_1_1R1",[ "QUERY_1_1R_R__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R_R__B",(K3.SR.TFloat))) ])),(K3.SR.Tuple([ (K3.SR.Var("QUERY_1_1R_R__B",(K3.SR.TFloat))); (K3.SR.Add((K3.SR.Lookup((K3.SR.OutPC("QUERY_1_1R1",[ "QUERY_1_1R_R__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R_R__B",(K3.SR.TFloat))) ])),(K3.SR.Var("dv",(K3.SR.TFloat))))) ])),(K3.SR.Tuple([ (K3.SR.Var("QUERY_1_1R_R__B",(K3.SR.TFloat))); (K3.SR.Add((K3.SR.Const(M3.CFloat(0.))),(K3.SR.Var("dv",(K3.SR.TFloat))))) ])))))),(K3.SR.GroupByAggregate((K3.SR.AssocLambda(K3.SR.ATuple([ "QUERY_1_1R_R__B",(K3.SR.TFloat); "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat); "v2",(K3.SR.TFloat) ]),K3.SR.AVar("accv",(K3.SR.TFloat)),(K3.SR.Add((K3.SR.Mult((K3.SR.Var("QUERY_1_1R1S1T_D",(K3.SR.TFloat))),(K3.SR.Var("v2",(K3.SR.TFloat))))),(K3.SR.Var("accv",(K3.SR.TFloat))))))),(K3.SR.Const(M3.CFloat(0.))),(K3.SR.Lambda(K3.SR.ATuple([ "QUERY_1_1R_R__B",(K3.SR.TFloat); "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat); "v2",(K3.SR.TFloat) ]),(K3.SR.Tuple([ (K3.SR.Var("QUERY_1_1R_R__B",(K3.SR.TFloat))) ])))),(K3.SR.Slice((K3.SR.OutPC("QUERY_1_1R1T1",[ "QUERY_1_1R_R__B",(K3.SR.TFloat); "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ "QUERY_1_1R_R__B",(K3.SR.TFloat); "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat) ],([ "QUERY_1_1R1S1T_T__C",(K3.SR.Var("QUERY_1_1R1S1T_T__C",(K3.SR.TFloat))) ])))))))
in
   run_test_type
      "on_insert_t_step_2_gather_2"
      step_2
      "dbentry_map( [float] -> float)"

;;

let step_2_t =K3.SR.Iterate((K3.SR.Lambda(K3.SR.ATuple([ "QUERY_1_1R_R__B",(K3.SR.TFloat); "updated_v",(K3.SR.TFloat) ]),(K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1R1",[ "QUERY_1_1R_R__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R_R__B",(K3.SR.TFloat))) ],(K3.SR.Var("updated_v",(K3.SR.TFloat))))))),(K3.SR.Map((K3.SR.Lambda(K3.SR.ATuple([ "QUERY_1_1R_R__B",(K3.SR.TFloat); "dv",(K3.SR.TFloat) ]),(K3.SR.IfThenElse((K3.SR.Member((K3.SR.OutPC("QUERY_1_1R1",[ "QUERY_1_1R_R__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R_R__B",(K3.SR.TFloat))) ])),(K3.SR.Tuple([ (K3.SR.Var("QUERY_1_1R_R__B",(K3.SR.TFloat))); (K3.SR.Add((K3.SR.Lookup((K3.SR.OutPC("QUERY_1_1R1",[ "QUERY_1_1R_R__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R_R__B",(K3.SR.TFloat))) ])),(K3.SR.Var("dv",(K3.SR.TFloat))))) ])),(K3.SR.Tuple([ (K3.SR.Var("QUERY_1_1R_R__B",(K3.SR.TFloat))); (K3.SR.Add((K3.SR.Const(M3.CFloat(0.))),(K3.SR.Var("dv",(K3.SR.TFloat))))) ])))))),(K3.SR.GroupByAggregate((K3.SR.AssocLambda(K3.SR.ATuple([ "QUERY_1_1R_R__B",(K3.SR.TFloat); "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat); "v2",(K3.SR.TFloat) ]),K3.SR.AVar("accv",(K3.SR.TFloat)),(K3.SR.Add((K3.SR.Mult((K3.SR.Var("QUERY_1_1R1S1T_D",(K3.SR.TFloat))),(K3.SR.Var("v2",(K3.SR.TFloat))))),(K3.SR.Var("accv",(K3.SR.TFloat))))))),(K3.SR.Const(M3.CFloat(0.))),(K3.SR.Lambda(K3.SR.ATuple([ "QUERY_1_1R_R__B",(K3.SR.TFloat); "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat); "v2",(K3.SR.TFloat) ]),(K3.SR.Tuple([ (K3.SR.Var("QUERY_1_1R_R__B",(K3.SR.TFloat))) ])))),(K3.SR.Slice((K3.SR.OutPC("QUERY_1_1R1T1",[ "QUERY_1_1R_R__B",(K3.SR.TFloat); "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ "QUERY_1_1R_R__B",(K3.SR.TFloat); "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat) ],([ "QUERY_1_1R1S1T_T__C",(K3.SR.Var("QUERY_1_1R1S1T_T__C",(K3.SR.TFloat))) ]))))))))
in
   test_compile
      "on_insert_t_step_2" ["QUERY_1_1R1S1T_T__C";"QUERY_1_1R1S1T_D"]
      step_2_t

;;

let on_insert_t (*QUERY_1_1R1S1T_T__C,QUERY_1_1R1S1T_D*) = K3.SR.Block[
K3.SR.IfThenElse((K3.SR.Member((K3.SR.OutPC("QUERY_1_1T1",[ "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1S1T_T__C",(K3.SR.TFloat))) ])),(K3.SR.PCValueUpdate((K3.SR.SingletonPC("QUERY_1_1",(K3.SR.TFloat))),[  ],[  ],(K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("current_v",(K3.SR.TFloat)),(K3.SR.Add((K3.SR.Var("current_v",(K3.SR.TFloat))),(K3.SR.Mult((K3.SR.Lookup((K3.SR.OutPC("QUERY_1_1T1",[ "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1S1T_T__C",(K3.SR.TFloat))) ])),(K3.SR.Var("QUERY_1_1R1S1T_D",(K3.SR.TFloat))))))))),(K3.SR.SingletonPC("QUERY_1_1",(K3.SR.TFloat))))))),(K3.SR.PCValueUpdate((K3.SR.SingletonPC("QUERY_1_1",(K3.SR.TFloat))),[  ],[  ],(K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("current_v",(K3.SR.TFloat)),(K3.SR.Add((K3.SR.Var("current_v",(K3.SR.TFloat))),(K3.SR.Mult((K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("init_val",(K3.SR.TFloat)),(K3.SR.Block([ (K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1T1",[ "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R1S1T_T__C",(K3.SR.TFloat))) ],(K3.SR.Var("init_val",(K3.SR.TFloat))))); (K3.SR.Var("init_val",(K3.SR.TFloat))) ])))),(K3.SR.Const(M3.CFloat(0.))))),(K3.SR.Var("QUERY_1_1R1S1T_D",(K3.SR.TFloat))))))))),(K3.SR.SingletonPC("QUERY_1_1",(K3.SR.TFloat))))))));
K3.SR.Iterate((K3.SR.Lambda(K3.SR.ATuple([ "QUERY_1_1R_R__B",(K3.SR.TFloat); "updated_v",(K3.SR.TFloat) ]),(K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1R1",[ "QUERY_1_1R_R__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R_R__B",(K3.SR.TFloat))) ],(K3.SR.Var("updated_v",(K3.SR.TFloat))))))),(K3.SR.Map((K3.SR.Lambda(K3.SR.ATuple([ "QUERY_1_1R_R__B",(K3.SR.TFloat); "dv",(K3.SR.TFloat) ]),(K3.SR.IfThenElse((K3.SR.Member((K3.SR.OutPC("QUERY_1_1R1",[ "QUERY_1_1R_R__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R_R__B",(K3.SR.TFloat))) ])),(K3.SR.Tuple([ (K3.SR.Var("QUERY_1_1R_R__B",(K3.SR.TFloat))); (K3.SR.Add((K3.SR.Lookup((K3.SR.OutPC("QUERY_1_1R1",[ "QUERY_1_1R_R__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R_R__B",(K3.SR.TFloat))) ])),(K3.SR.Var("dv",(K3.SR.TFloat))))) ])),(K3.SR.Tuple([ (K3.SR.Var("QUERY_1_1R_R__B",(K3.SR.TFloat))); (K3.SR.Add((K3.SR.Const(M3.CFloat(0.))),(K3.SR.Var("dv",(K3.SR.TFloat))))) ])))))),(K3.SR.GroupByAggregate((K3.SR.AssocLambda(K3.SR.ATuple([ "QUERY_1_1R_R__B",(K3.SR.TFloat); "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat); "v2",(K3.SR.TFloat) ]),K3.SR.AVar("accv",(K3.SR.TFloat)),(K3.SR.Add((K3.SR.Mult((K3.SR.Var("QUERY_1_1R1S1T_D",(K3.SR.TFloat))),(K3.SR.Var("v2",(K3.SR.TFloat))))),(K3.SR.Var("accv",(K3.SR.TFloat))))))),(K3.SR.Const(M3.CFloat(0.))),(K3.SR.Lambda(K3.SR.ATuple([ "QUERY_1_1R_R__B",(K3.SR.TFloat); "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat); "v2",(K3.SR.TFloat) ]),(K3.SR.Tuple([ (K3.SR.Var("QUERY_1_1R_R__B",(K3.SR.TFloat))) ])))),(K3.SR.Slice((K3.SR.OutPC("QUERY_1_1R1T1",[ "QUERY_1_1R_R__B",(K3.SR.TFloat); "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ "QUERY_1_1R_R__B",(K3.SR.TFloat); "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat) ],([ "QUERY_1_1R1S1T_T__C",(K3.SR.Var("QUERY_1_1R1S1T_T__C",(K3.SR.TFloat))) ]))))))));
K3.SR.IfThenElse((K3.SR.Member((K3.SR.OutPC("QUERY_1_1R1S1",[ "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1S1T_T__C",(K3.SR.TFloat))) ])),(K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1R1S1",[ "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R1S1T_T__C",(K3.SR.TFloat))) ],(K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("current_v",(K3.SR.TFloat)),(K3.SR.Add((K3.SR.Var("current_v",(K3.SR.TFloat))),(K3.SR.Var("QUERY_1_1R1S1T_D",(K3.SR.TFloat))))))),(K3.SR.Lookup((K3.SR.OutPC("QUERY_1_1R1S1",[ "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1S1T_T__C",(K3.SR.TFloat))) ])))))),(K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1R1S1",[ "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R1S1T_T__C",(K3.SR.TFloat))) ],(K3.SR.Add((K3.SR.Var("QUERY_1_1R1S1T_D",(K3.SR.TFloat))),(K3.SR.Const(M3.CFloat(0.))))))))
]
in
   test_compile 
      "on_insert_t" ["QUERY_1_1R1S1T_T__C";"QUERY_1_1R1S1T_D"]
      on_insert_t

;;

let on_insert_s (*QUERY_1_1R1T1S_S__B,QUERY_1_1R1T1S_S__C*) = K3.SR.Block[
K3.SR.IfThenElse((K3.SR.Member((K3.SR.OutPC("QUERY_1_1S1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))) ])),(K3.SR.IfThenElse((K3.SR.Member((K3.SR.OutPC("QUERY_1_1R1S1",[ "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ])),(K3.SR.PCValueUpdate((K3.SR.SingletonPC("QUERY_1_1",(K3.SR.TFloat))),[  ],[  ],(K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("current_v",(K3.SR.TFloat)),(K3.SR.Add((K3.SR.Var("current_v",(K3.SR.TFloat))),(K3.SR.Mult((K3.SR.Lookup((K3.SR.OutPC("QUERY_1_1S1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))) ])),(K3.SR.Lookup((K3.SR.OutPC("QUERY_1_1R1S1",[ "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ])))))))),(K3.SR.SingletonPC("QUERY_1_1",(K3.SR.TFloat))))))),(K3.SR.PCValueUpdate((K3.SR.SingletonPC("QUERY_1_1",(K3.SR.TFloat))),[  ],[  ],(K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("current_v",(K3.SR.TFloat)),(K3.SR.Add((K3.SR.Var("current_v",(K3.SR.TFloat))),(K3.SR.Mult((K3.SR.Lookup((K3.SR.OutPC("QUERY_1_1S1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))) ])),(K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("init_val",(K3.SR.TFloat)),(K3.SR.Block([ (K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1R1S1",[ "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ],(K3.SR.Var("init_val",(K3.SR.TFloat))))); (K3.SR.Var("init_val",(K3.SR.TFloat))) ])))),(K3.SR.Const(M3.CFloat(0.))))))))))),(K3.SR.SingletonPC("QUERY_1_1",(K3.SR.TFloat))))))))),(K3.SR.IfThenElse((K3.SR.Member((K3.SR.OutPC("QUERY_1_1R1S1",[ "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ])),(K3.SR.PCValueUpdate((K3.SR.SingletonPC("QUERY_1_1",(K3.SR.TFloat))),[  ],[  ],(K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("current_v",(K3.SR.TFloat)),(K3.SR.Add((K3.SR.Var("current_v",(K3.SR.TFloat))),(K3.SR.Mult((K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("init_val",(K3.SR.TFloat)),(K3.SR.Block([ (K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1S1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))) ],(K3.SR.Var("init_val",(K3.SR.TFloat))))); (K3.SR.Var("init_val",(K3.SR.TFloat))) ])))),(K3.SR.Const(M3.CFloat(0.))))),(K3.SR.Lookup((K3.SR.OutPC("QUERY_1_1R1S1",[ "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ])))))))),(K3.SR.SingletonPC("QUERY_1_1",(K3.SR.TFloat))))))),(K3.SR.PCValueUpdate((K3.SR.SingletonPC("QUERY_1_1",(K3.SR.TFloat))),[  ],[  ],(K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("current_v",(K3.SR.TFloat)),(K3.SR.Add((K3.SR.Var("current_v",(K3.SR.TFloat))),(K3.SR.Mult((K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("init_val",(K3.SR.TFloat)),(K3.SR.Block([ (K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1S1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))) ],(K3.SR.Var("init_val",(K3.SR.TFloat))))); (K3.SR.Var("init_val",(K3.SR.TFloat))) ])))),(K3.SR.Const(M3.CFloat(0.))))),(K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("init_val",(K3.SR.TFloat)),(K3.SR.Block([ (K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1R1S1",[ "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ],(K3.SR.Var("init_val",(K3.SR.TFloat))))); (K3.SR.Var("init_val",(K3.SR.TFloat))) ])))),(K3.SR.Const(M3.CFloat(0.))))))))))),(K3.SR.SingletonPC("QUERY_1_1",(K3.SR.TFloat))))))))));
K3.SR.IfThenElse((K3.SR.Member((K3.SR.OutPC("QUERY_1_1T1",[ "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ])),(K3.SR.IfThenElse((K3.SR.Member((K3.SR.OutPC("QUERY_1_1S1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))) ])),(K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1T1",[ "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ],(K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("current_v",(K3.SR.TFloat)),(K3.SR.Add((K3.SR.Var("current_v",(K3.SR.TFloat))),(K3.SR.Lookup((K3.SR.OutPC("QUERY_1_1S1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))) ])))))),(K3.SR.Lookup((K3.SR.OutPC("QUERY_1_1T1",[ "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ])))))),(K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1T1",[ "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ],(K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("current_v",(K3.SR.TFloat)),(K3.SR.Add((K3.SR.Var("current_v",(K3.SR.TFloat))),(K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("init_val",(K3.SR.TFloat)),(K3.SR.Block([ (K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1S1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))) ],(K3.SR.Var("init_val",(K3.SR.TFloat))))); (K3.SR.Var("init_val",(K3.SR.TFloat))) ])))),(K3.SR.Const(M3.CFloat(0.))))))))),(K3.SR.Lookup((K3.SR.OutPC("QUERY_1_1T1",[ "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ])))))))),(K3.SR.IfThenElse((K3.SR.Member((K3.SR.OutPC("QUERY_1_1S1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))) ])),(K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1T1",[ "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ],(K3.SR.Add((K3.SR.Lookup((K3.SR.OutPC("QUERY_1_1S1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))) ])),(K3.SR.Const(M3.CFloat(0.))))))),(K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1T1",[ "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ],(K3.SR.Add((K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("init_val",(K3.SR.TFloat)),(K3.SR.Block([ (K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1S1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))) ],(K3.SR.Var("init_val",(K3.SR.TFloat))))); (K3.SR.Var("init_val",(K3.SR.TFloat))) ])))),(K3.SR.Const(M3.CFloat(0.))))),(K3.SR.Const(M3.CFloat(0.))))))))));
K3.SR.IfThenElse((K3.SR.Member((K3.SR.OutPC("QUERY_1_1R1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))) ])),(K3.SR.IfThenElse((K3.SR.Member((K3.SR.OutPC("QUERY_1_1R1S1",[ "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ])),(K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1R1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))) ],(K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("current_v",(K3.SR.TFloat)),(K3.SR.Add((K3.SR.Var("current_v",(K3.SR.TFloat))),(K3.SR.Lookup((K3.SR.OutPC("QUERY_1_1R1S1",[ "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ])))))),(K3.SR.Lookup((K3.SR.OutPC("QUERY_1_1R1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))) ])))))),(K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1R1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))) ],(K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("current_v",(K3.SR.TFloat)),(K3.SR.Add((K3.SR.Var("current_v",(K3.SR.TFloat))),(K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("init_val",(K3.SR.TFloat)),(K3.SR.Block([ (K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1R1S1",[ "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ],(K3.SR.Var("init_val",(K3.SR.TFloat))))); (K3.SR.Var("init_val",(K3.SR.TFloat))) ])))),(K3.SR.Const(M3.CFloat(0.))))))))),(K3.SR.Lookup((K3.SR.OutPC("QUERY_1_1R1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))) ])))))))),(K3.SR.IfThenElse((K3.SR.Member((K3.SR.OutPC("QUERY_1_1R1S1",[ "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ])),(K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1R1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))) ],(K3.SR.Add((K3.SR.Lookup((K3.SR.OutPC("QUERY_1_1R1S1",[ "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ])),(K3.SR.Const(M3.CFloat(0.))))))),(K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1R1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))) ],(K3.SR.Add((K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("init_val",(K3.SR.TFloat)),(K3.SR.Block([ (K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1R1S1",[ "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ],(K3.SR.Var("init_val",(K3.SR.TFloat))))); (K3.SR.Var("init_val",(K3.SR.TFloat))) ])))),(K3.SR.Const(M3.CFloat(0.))))),(K3.SR.Const(M3.CFloat(0.))))))))));
K3.SR.IfThenElse((K3.SR.Member((K3.SR.OutPC("QUERY_1_1R1T1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat); "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))); (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ])),(K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1R1T1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat); "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))); (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ],(K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("current_v",(K3.SR.TFloat)),(K3.SR.Add((K3.SR.Var("current_v",(K3.SR.TFloat))),(K3.SR.Const(M3.CFloat(1.))))))),(K3.SR.Lookup((K3.SR.OutPC("QUERY_1_1R1T1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat); "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))); (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ])))))),(K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1R1T1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat); "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))); (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ],(K3.SR.Add((K3.SR.Const(M3.CFloat(1.))),(K3.SR.Const(M3.CFloat(0.))))))))
]
in
   test_compile 
      "on_insert_s" ["QUERY_1_1R1T1S_S__B";"QUERY_1_1R1T1S_S__C"]
      on_insert_s

;;

let on_insert_r (*QUERY_1_1S1R_A,QUERY_1_1S1R_R__B*) = K3.SR.Block[
K3.SR.IfThenElse((K3.SR.Member((K3.SR.OutPC("QUERY_1_1R1",[ "QUERY_1_1S1R_R__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1S1R_R__B",(K3.SR.TFloat))) ])),(K3.SR.PCValueUpdate((K3.SR.SingletonPC("QUERY_1_1",(K3.SR.TFloat))),[  ],[  ],(K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("current_v",(K3.SR.TFloat)),(K3.SR.Add((K3.SR.Var("current_v",(K3.SR.TFloat))),(K3.SR.Mult((K3.SR.Var("QUERY_1_1S1R_A",(K3.SR.TFloat))),(K3.SR.Lookup((K3.SR.OutPC("QUERY_1_1R1",[ "QUERY_1_1S1R_R__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1S1R_R__B",(K3.SR.TFloat))) ])))))))),(K3.SR.SingletonPC("QUERY_1_1",(K3.SR.TFloat))))))),(K3.SR.PCValueUpdate((K3.SR.SingletonPC("QUERY_1_1",(K3.SR.TFloat))),[  ],[  ],(K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("current_v",(K3.SR.TFloat)),(K3.SR.Add((K3.SR.Var("current_v",(K3.SR.TFloat))),(K3.SR.Mult((K3.SR.Var("QUERY_1_1S1R_A",(K3.SR.TFloat))),(K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("init_val",(K3.SR.TFloat)),(K3.SR.Block([ (K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1R1",[ "QUERY_1_1S1R_R__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1S1R_R__B",(K3.SR.TFloat))) ],(K3.SR.Var("init_val",(K3.SR.TFloat))))); (K3.SR.Var("init_val",(K3.SR.TFloat))) ])))),(K3.SR.Const(M3.CFloat(0.))))))))))),(K3.SR.SingletonPC("QUERY_1_1",(K3.SR.TFloat))))))));
K3.SR.Iterate((K3.SR.Lambda(K3.SR.ATuple([ "QUERY_1_1T_T__C",(K3.SR.TFloat); "updated_v",(K3.SR.TFloat) ]),(K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1T1",[ "QUERY_1_1T_T__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1T_T__C",(K3.SR.TFloat))) ],(K3.SR.Var("updated_v",(K3.SR.TFloat))))))),(K3.SR.Map((K3.SR.Lambda(K3.SR.ATuple([ "QUERY_1_1T_T__C",(K3.SR.TFloat); "dv",(K3.SR.TFloat) ]),(K3.SR.IfThenElse((K3.SR.Member((K3.SR.OutPC("QUERY_1_1T1",[ "QUERY_1_1T_T__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1T_T__C",(K3.SR.TFloat))) ])),(K3.SR.Tuple([ (K3.SR.Var("QUERY_1_1T_T__C",(K3.SR.TFloat))); (K3.SR.Add((K3.SR.Lookup((K3.SR.OutPC("QUERY_1_1T1",[ "QUERY_1_1T_T__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1T_T__C",(K3.SR.TFloat))) ])),(K3.SR.Var("dv",(K3.SR.TFloat))))) ])),(K3.SR.Tuple([ (K3.SR.Var("QUERY_1_1T_T__C",(K3.SR.TFloat))); (K3.SR.Add((K3.SR.Const(M3.CFloat(0.))),(K3.SR.Var("dv",(K3.SR.TFloat))))) ])))))),(K3.SR.GroupByAggregate((K3.SR.AssocLambda(K3.SR.ATuple([ "QUERY_1_1S1R_R__B",(K3.SR.TFloat); "QUERY_1_1T_T__C",(K3.SR.TFloat); "v2",(K3.SR.TFloat) ]),K3.SR.AVar("accv",(K3.SR.TFloat)),(K3.SR.Add((K3.SR.Mult((K3.SR.Var("QUERY_1_1S1R_A",(K3.SR.TFloat))),(K3.SR.Var("v2",(K3.SR.TFloat))))),(K3.SR.Var("accv",(K3.SR.TFloat))))))),(K3.SR.Const(M3.CFloat(0.))),(K3.SR.Lambda(K3.SR.ATuple([ "QUERY_1_1S1R_R__B",(K3.SR.TFloat); "QUERY_1_1T_T__C",(K3.SR.TFloat); "v2",(K3.SR.TFloat) ]),(K3.SR.Tuple([ (K3.SR.Var("QUERY_1_1T_T__C",(K3.SR.TFloat))) ])))),(K3.SR.Slice((K3.SR.OutPC("QUERY_1_1R1T1",[ "QUERY_1_1S1R_R__B",(K3.SR.TFloat); "QUERY_1_1T_T__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ "QUERY_1_1S1R_R__B",(K3.SR.TFloat); "QUERY_1_1T_T__C",(K3.SR.TFloat) ],([ "QUERY_1_1S1R_R__B",(K3.SR.Var("QUERY_1_1S1R_R__B",(K3.SR.TFloat))) ]))))))));
K3.SR.IfThenElse((K3.SR.Member((K3.SR.OutPC("QUERY_1_1S1",[ "QUERY_1_1S1R_R__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1S1R_R__B",(K3.SR.TFloat))) ])),(K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1S1",[ "QUERY_1_1S1R_R__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1S1R_R__B",(K3.SR.TFloat))) ],(K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("current_v",(K3.SR.TFloat)),(K3.SR.Add((K3.SR.Var("current_v",(K3.SR.TFloat))),(K3.SR.Var("QUERY_1_1S1R_A",(K3.SR.TFloat))))))),(K3.SR.Lookup((K3.SR.OutPC("QUERY_1_1S1",[ "QUERY_1_1S1R_R__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1S1R_R__B",(K3.SR.TFloat))) ])))))),(K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1S1",[ "QUERY_1_1S1R_R__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1S1R_R__B",(K3.SR.TFloat))) ],(K3.SR.Add((K3.SR.Var("QUERY_1_1S1R_A",(K3.SR.TFloat))),(K3.SR.Const(M3.CFloat(0.))))))))  
]
in
   test_compile 
      "on_insert_r" ["QUERY_1_1S1R_A";"QUERY_1_1S1R_R__B"]
      on_insert_r

;;

let on_delete_t (*QUERY_1_1R1S1T_T__C,QUERY_1_1R1S1T_D*) = K3.SR.Block[
K3.SR.IfThenElse((K3.SR.Member((K3.SR.OutPC("QUERY_1_1T1",[ "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1S1T_T__C",(K3.SR.TFloat))) ])),(K3.SR.PCValueUpdate((K3.SR.SingletonPC("QUERY_1_1",(K3.SR.TFloat))),[  ],[  ],(K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("current_v",(K3.SR.TFloat)),(K3.SR.Add((K3.SR.Var("current_v",(K3.SR.TFloat))),(K3.SR.Mult((K3.SR.Lookup((K3.SR.OutPC("QUERY_1_1T1",[ "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1S1T_T__C",(K3.SR.TFloat))) ])),(K3.SR.Mult((K3.SR.Var("QUERY_1_1R1S1T_D",(K3.SR.TFloat))),(K3.SR.Const(M3.CFloat(-1.))))))))))),(K3.SR.SingletonPC("QUERY_1_1",(K3.SR.TFloat))))))),(K3.SR.PCValueUpdate((K3.SR.SingletonPC("QUERY_1_1",(K3.SR.TFloat))),[  ],[  ],(K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("current_v",(K3.SR.TFloat)),(K3.SR.Add((K3.SR.Var("current_v",(K3.SR.TFloat))),(K3.SR.Mult((K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("init_val",(K3.SR.TFloat)),(K3.SR.Block([ (K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1T1",[ "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R1S1T_T__C",(K3.SR.TFloat))) ],(K3.SR.Var("init_val",(K3.SR.TFloat))))); (K3.SR.Var("init_val",(K3.SR.TFloat))) ])))),(K3.SR.Const(M3.CFloat(0.))))),(K3.SR.Mult((K3.SR.Var("QUERY_1_1R1S1T_D",(K3.SR.TFloat))),(K3.SR.Const(M3.CFloat(-1.))))))))))),(K3.SR.SingletonPC("QUERY_1_1",(K3.SR.TFloat))))))));
K3.SR.Iterate((K3.SR.Lambda(K3.SR.ATuple([ "QUERY_1_1R_R__B",(K3.SR.TFloat); "updated_v",(K3.SR.TFloat) ]),(K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1R1",[ "QUERY_1_1R_R__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R_R__B",(K3.SR.TFloat))) ],(K3.SR.Var("updated_v",(K3.SR.TFloat))))))),(K3.SR.Map((K3.SR.Lambda(K3.SR.ATuple([ "QUERY_1_1R_R__B",(K3.SR.TFloat); "dv",(K3.SR.TFloat) ]),(K3.SR.IfThenElse((K3.SR.Member((K3.SR.OutPC("QUERY_1_1R1",[ "QUERY_1_1R_R__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R_R__B",(K3.SR.TFloat))) ])),(K3.SR.Tuple([ (K3.SR.Var("QUERY_1_1R_R__B",(K3.SR.TFloat))); (K3.SR.Add((K3.SR.Lookup((K3.SR.OutPC("QUERY_1_1R1",[ "QUERY_1_1R_R__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R_R__B",(K3.SR.TFloat))) ])),(K3.SR.Var("dv",(K3.SR.TFloat))))) ])),(K3.SR.Tuple([ (K3.SR.Var("QUERY_1_1R_R__B",(K3.SR.TFloat))); (K3.SR.Add((K3.SR.Const(M3.CFloat(0.))),(K3.SR.Var("dv",(K3.SR.TFloat))))) ])))))),(K3.SR.GroupByAggregate((K3.SR.AssocLambda(K3.SR.ATuple([ "QUERY_1_1R_R__B",(K3.SR.TFloat); "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat); "v1",(K3.SR.TFloat) ]),K3.SR.AVar("accv",(K3.SR.TFloat)),(K3.SR.Add((K3.SR.Mult((K3.SR.Var("QUERY_1_1R1S1T_D",(K3.SR.TFloat))),(K3.SR.Mult((K3.SR.Var("v1",(K3.SR.TFloat))),(K3.SR.Const(M3.CFloat(-1.))))))),(K3.SR.Var("accv",(K3.SR.TFloat))))))),(K3.SR.Const(M3.CFloat(0.))),(K3.SR.Lambda(K3.SR.ATuple([ "QUERY_1_1R_R__B",(K3.SR.TFloat); "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat); "v1",(K3.SR.TFloat) ]),(K3.SR.Tuple([ (K3.SR.Var("QUERY_1_1R_R__B",(K3.SR.TFloat))) ])))),(K3.SR.Slice((K3.SR.OutPC("QUERY_1_1R1T1",[ "QUERY_1_1R_R__B",(K3.SR.TFloat); "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ "QUERY_1_1R_R__B",(K3.SR.TFloat); "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat) ],([ "QUERY_1_1R1S1T_T__C",(K3.SR.Var("QUERY_1_1R1S1T_T__C",(K3.SR.TFloat))) ]))))))));
K3.SR.IfThenElse((K3.SR.Member((K3.SR.OutPC("QUERY_1_1R1S1",[ "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1S1T_T__C",(K3.SR.TFloat))) ])),(K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1R1S1",[ "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R1S1T_T__C",(K3.SR.TFloat))) ],(K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("current_v",(K3.SR.TFloat)),(K3.SR.Add((K3.SR.Var("current_v",(K3.SR.TFloat))),(K3.SR.Mult((K3.SR.Var("QUERY_1_1R1S1T_D",(K3.SR.TFloat))),(K3.SR.Const(M3.CFloat(-1.))))))))),(K3.SR.Lookup((K3.SR.OutPC("QUERY_1_1R1S1",[ "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1S1T_T__C",(K3.SR.TFloat))) ])))))),(K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1R1S1",[ "QUERY_1_1R1S1T_T__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R1S1T_T__C",(K3.SR.TFloat))) ],(K3.SR.Add((K3.SR.Mult((K3.SR.Var("QUERY_1_1R1S1T_D",(K3.SR.TFloat))),(K3.SR.Const(M3.CFloat(-1.))))),(K3.SR.Const(M3.CFloat(0.))))))))
]
in
   test_compile 
      "on_delete_t" ["QUERY_1_1R1S1T_T__C";"QUERY_1_1R1S1T_D"]
      on_delete_t

;;

let on_delete_s (*QUERY_1_1R1T1S_S__B,QUERY_1_1R1T1S_S__C*) = K3.SR.Block[
K3.SR.IfThenElse((K3.SR.Member((K3.SR.OutPC("QUERY_1_1S1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))) ])),(K3.SR.IfThenElse((K3.SR.Member((K3.SR.OutPC("QUERY_1_1R1S1",[ "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ])),(K3.SR.PCValueUpdate((K3.SR.SingletonPC("QUERY_1_1",(K3.SR.TFloat))),[  ],[  ],(K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("current_v",(K3.SR.TFloat)),(K3.SR.Add((K3.SR.Var("current_v",(K3.SR.TFloat))),(K3.SR.Mult((K3.SR.Lookup((K3.SR.OutPC("QUERY_1_1S1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))) ])),(K3.SR.Mult((K3.SR.Lookup((K3.SR.OutPC("QUERY_1_1R1S1",[ "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ])),(K3.SR.Const(M3.CFloat(-1.))))))))))),(K3.SR.SingletonPC("QUERY_1_1",(K3.SR.TFloat))))))),(K3.SR.PCValueUpdate((K3.SR.SingletonPC("QUERY_1_1",(K3.SR.TFloat))),[  ],[  ],(K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("current_v",(K3.SR.TFloat)),(K3.SR.Add((K3.SR.Var("current_v",(K3.SR.TFloat))),(K3.SR.Mult((K3.SR.Lookup((K3.SR.OutPC("QUERY_1_1S1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))) ])),(K3.SR.Mult((K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("init_val",(K3.SR.TFloat)),(K3.SR.Block([ (K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1R1S1",[ "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ],(K3.SR.Var("init_val",(K3.SR.TFloat))))); (K3.SR.Var("init_val",(K3.SR.TFloat))) ])))),(K3.SR.Const(M3.CFloat(0.))))),(K3.SR.Const(M3.CFloat(-1.))))))))))),(K3.SR.SingletonPC("QUERY_1_1",(K3.SR.TFloat))))))))),(K3.SR.IfThenElse((K3.SR.Member((K3.SR.OutPC("QUERY_1_1R1S1",[ "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ])),(K3.SR.PCValueUpdate((K3.SR.SingletonPC("QUERY_1_1",(K3.SR.TFloat))),[  ],[  ],(K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("current_v",(K3.SR.TFloat)),(K3.SR.Add((K3.SR.Var("current_v",(K3.SR.TFloat))),(K3.SR.Mult((K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("init_val",(K3.SR.TFloat)),(K3.SR.Block([ (K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1S1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))) ],(K3.SR.Var("init_val",(K3.SR.TFloat))))); (K3.SR.Var("init_val",(K3.SR.TFloat))) ])))),(K3.SR.Const(M3.CFloat(0.))))),(K3.SR.Mult((K3.SR.Lookup((K3.SR.OutPC("QUERY_1_1R1S1",[ "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ])),(K3.SR.Const(M3.CFloat(-1.))))))))))),(K3.SR.SingletonPC("QUERY_1_1",(K3.SR.TFloat))))))),(K3.SR.PCValueUpdate((K3.SR.SingletonPC("QUERY_1_1",(K3.SR.TFloat))),[  ],[  ],(K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("current_v",(K3.SR.TFloat)),(K3.SR.Add((K3.SR.Var("current_v",(K3.SR.TFloat))),(K3.SR.Mult((K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("init_val",(K3.SR.TFloat)),(K3.SR.Block([ (K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1S1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))) ],(K3.SR.Var("init_val",(K3.SR.TFloat))))); (K3.SR.Var("init_val",(K3.SR.TFloat))) ])))),(K3.SR.Const(M3.CFloat(0.))))),(K3.SR.Mult((K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("init_val",(K3.SR.TFloat)),(K3.SR.Block([ (K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1R1S1",[ "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ],(K3.SR.Var("init_val",(K3.SR.TFloat))))); (K3.SR.Var("init_val",(K3.SR.TFloat))) ])))),(K3.SR.Const(M3.CFloat(0.))))),(K3.SR.Const(M3.CFloat(-1.))))))))))),(K3.SR.SingletonPC("QUERY_1_1",(K3.SR.TFloat))))))))));
K3.SR.IfThenElse((K3.SR.Member((K3.SR.OutPC("QUERY_1_1T1",[ "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ])),(K3.SR.IfThenElse((K3.SR.Member((K3.SR.OutPC("QUERY_1_1S1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))) ])),(K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1T1",[ "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ],(K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("current_v",(K3.SR.TFloat)),(K3.SR.Add((K3.SR.Var("current_v",(K3.SR.TFloat))),(K3.SR.Mult((K3.SR.Lookup((K3.SR.OutPC("QUERY_1_1S1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))) ])),(K3.SR.Const(M3.CFloat(-1.))))))))),(K3.SR.Lookup((K3.SR.OutPC("QUERY_1_1T1",[ "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ])))))),(K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1T1",[ "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ],(K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("current_v",(K3.SR.TFloat)),(K3.SR.Add((K3.SR.Var("current_v",(K3.SR.TFloat))),(K3.SR.Mult((K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("init_val",(K3.SR.TFloat)),(K3.SR.Block([ (K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1S1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))) ],(K3.SR.Var("init_val",(K3.SR.TFloat))))); (K3.SR.Var("init_val",(K3.SR.TFloat))) ])))),(K3.SR.Const(M3.CFloat(0.))))),(K3.SR.Const(M3.CFloat(-1.))))))))),(K3.SR.Lookup((K3.SR.OutPC("QUERY_1_1T1",[ "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ])))))))),(K3.SR.IfThenElse((K3.SR.Member((K3.SR.OutPC("QUERY_1_1S1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))) ])),(K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1T1",[ "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ],(K3.SR.Add((K3.SR.Mult((K3.SR.Lookup((K3.SR.OutPC("QUERY_1_1S1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))) ])),(K3.SR.Const(M3.CFloat(-1.))))),(K3.SR.Const(M3.CFloat(0.))))))),(K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1T1",[ "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ],(K3.SR.Add((K3.SR.Mult((K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("init_val",(K3.SR.TFloat)),(K3.SR.Block([ (K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1S1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))) ],(K3.SR.Var("init_val",(K3.SR.TFloat))))); (K3.SR.Var("init_val",(K3.SR.TFloat))) ])))),(K3.SR.Const(M3.CFloat(0.))))),(K3.SR.Const(M3.CFloat(-1.))))),(K3.SR.Const(M3.CFloat(0.))))))))));
K3.SR.IfThenElse((K3.SR.Member((K3.SR.OutPC("QUERY_1_1R1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))) ])),(K3.SR.IfThenElse((K3.SR.Member((K3.SR.OutPC("QUERY_1_1R1S1",[ "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ])),(K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1R1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))) ],(K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("current_v",(K3.SR.TFloat)),(K3.SR.Add((K3.SR.Var("current_v",(K3.SR.TFloat))),(K3.SR.Mult((K3.SR.Lookup((K3.SR.OutPC("QUERY_1_1R1S1",[ "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ])),(K3.SR.Const(M3.CFloat(-1.))))))))),(K3.SR.Lookup((K3.SR.OutPC("QUERY_1_1R1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))) ])))))),(K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1R1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))) ],(K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("current_v",(K3.SR.TFloat)),(K3.SR.Add((K3.SR.Var("current_v",(K3.SR.TFloat))),(K3.SR.Mult((K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("init_val",(K3.SR.TFloat)),(K3.SR.Block([ (K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1R1S1",[ "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ],(K3.SR.Var("init_val",(K3.SR.TFloat))))); (K3.SR.Var("init_val",(K3.SR.TFloat))) ])))),(K3.SR.Const(M3.CFloat(0.))))),(K3.SR.Const(M3.CFloat(-1.))))))))),(K3.SR.Lookup((K3.SR.OutPC("QUERY_1_1R1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))) ])))))))),(K3.SR.IfThenElse((K3.SR.Member((K3.SR.OutPC("QUERY_1_1R1S1",[ "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ])),(K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1R1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))) ],(K3.SR.Add((K3.SR.Mult((K3.SR.Lookup((K3.SR.OutPC("QUERY_1_1R1S1",[ "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ])),(K3.SR.Const(M3.CFloat(-1.))))),(K3.SR.Const(M3.CFloat(0.))))))),(K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1R1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))) ],(K3.SR.Add((K3.SR.Mult((K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("init_val",(K3.SR.TFloat)),(K3.SR.Block([ (K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1R1S1",[ "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ],(K3.SR.Var("init_val",(K3.SR.TFloat))))); (K3.SR.Var("init_val",(K3.SR.TFloat))) ])))),(K3.SR.Const(M3.CFloat(0.))))),(K3.SR.Const(M3.CFloat(-1.))))),(K3.SR.Const(M3.CFloat(0.))))))))));
K3.SR.IfThenElse((K3.SR.Member((K3.SR.OutPC("QUERY_1_1R1T1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat); "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))); (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ])),(K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1R1T1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat); "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))); (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ],(K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("current_v",(K3.SR.TFloat)),(K3.SR.Add((K3.SR.Var("current_v",(K3.SR.TFloat))),(K3.SR.Const(M3.CFloat(-1.))))))),(K3.SR.Lookup((K3.SR.OutPC("QUERY_1_1R1T1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat); "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))); (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ])))))),(K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1R1T1",[ "QUERY_1_1R1T1S_S__B",(K3.SR.TFloat); "QUERY_1_1R1T1S_S__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1R1T1S_S__B",(K3.SR.TFloat))); (K3.SR.Var("QUERY_1_1R1T1S_S__C",(K3.SR.TFloat))) ],(K3.SR.Add((K3.SR.Const(M3.CFloat(-1.))),(K3.SR.Const(M3.CFloat(0.))))))))
]
in
   test_compile 
      "on_delete_s" ["QUERY_1_1R1T1S_S__B";"QUERY_1_1R1T1S_S__C"]
      on_delete_s

;;

let on_delete_r (*QUERY_1_1S1R_A,QUERY_1_1S1R_R__B*) = K3.SR.Block[
K3.SR.IfThenElse((K3.SR.Member((K3.SR.OutPC("QUERY_1_1R1",[ "QUERY_1_1S1R_R__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1S1R_R__B",(K3.SR.TFloat))) ])),(K3.SR.PCValueUpdate((K3.SR.SingletonPC("QUERY_1_1",(K3.SR.TFloat))),[  ],[  ],(K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("current_v",(K3.SR.TFloat)),(K3.SR.Add((K3.SR.Var("current_v",(K3.SR.TFloat))),(K3.SR.Mult((K3.SR.Var("QUERY_1_1S1R_A",(K3.SR.TFloat))),(K3.SR.Mult((K3.SR.Lookup((K3.SR.OutPC("QUERY_1_1R1",[ "QUERY_1_1S1R_R__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1S1R_R__B",(K3.SR.TFloat))) ])),(K3.SR.Const(M3.CFloat(-1.))))))))))),(K3.SR.SingletonPC("QUERY_1_1",(K3.SR.TFloat))))))),(K3.SR.PCValueUpdate((K3.SR.SingletonPC("QUERY_1_1",(K3.SR.TFloat))),[  ],[  ],(K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("current_v",(K3.SR.TFloat)),(K3.SR.Add((K3.SR.Var("current_v",(K3.SR.TFloat))),(K3.SR.Mult((K3.SR.Var("QUERY_1_1S1R_A",(K3.SR.TFloat))),(K3.SR.Mult((K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("init_val",(K3.SR.TFloat)),(K3.SR.Block([ (K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1R1",[ "QUERY_1_1S1R_R__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1S1R_R__B",(K3.SR.TFloat))) ],(K3.SR.Var("init_val",(K3.SR.TFloat))))); (K3.SR.Var("init_val",(K3.SR.TFloat))) ])))),(K3.SR.Const(M3.CFloat(0.))))),(K3.SR.Const(M3.CFloat(-1.))))))))))),(K3.SR.SingletonPC("QUERY_1_1",(K3.SR.TFloat))))))));
K3.SR.Iterate((K3.SR.Lambda(K3.SR.ATuple([ "QUERY_1_1T_T__C",(K3.SR.TFloat); "updated_v",(K3.SR.TFloat) ]),(K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1T1",[ "QUERY_1_1T_T__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1T_T__C",(K3.SR.TFloat))) ],(K3.SR.Var("updated_v",(K3.SR.TFloat))))))),(K3.SR.Map((K3.SR.Lambda(K3.SR.ATuple([ "QUERY_1_1T_T__C",(K3.SR.TFloat); "dv",(K3.SR.TFloat) ]),(K3.SR.IfThenElse((K3.SR.Member((K3.SR.OutPC("QUERY_1_1T1",[ "QUERY_1_1T_T__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1T_T__C",(K3.SR.TFloat))) ])),(K3.SR.Tuple([ (K3.SR.Var("QUERY_1_1T_T__C",(K3.SR.TFloat))); (K3.SR.Add((K3.SR.Lookup((K3.SR.OutPC("QUERY_1_1T1",[ "QUERY_1_1T_T__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1T_T__C",(K3.SR.TFloat))) ])),(K3.SR.Var("dv",(K3.SR.TFloat))))) ])),(K3.SR.Tuple([ (K3.SR.Var("QUERY_1_1T_T__C",(K3.SR.TFloat))); (K3.SR.Add((K3.SR.Const(M3.CFloat(0.))),(K3.SR.Var("dv",(K3.SR.TFloat))))) ])))))),(K3.SR.GroupByAggregate((K3.SR.AssocLambda(K3.SR.ATuple([ "QUERY_1_1S1R_R__B",(K3.SR.TFloat); "QUERY_1_1T_T__C",(K3.SR.TFloat); "v1",(K3.SR.TFloat) ]),K3.SR.AVar("accv",(K3.SR.TFloat)),(K3.SR.Add((K3.SR.Mult((K3.SR.Var("QUERY_1_1S1R_A",(K3.SR.TFloat))),(K3.SR.Mult((K3.SR.Var("v1",(K3.SR.TFloat))),(K3.SR.Const(M3.CFloat(-1.))))))),(K3.SR.Var("accv",(K3.SR.TFloat))))))),(K3.SR.Const(M3.CFloat(0.))),(K3.SR.Lambda(K3.SR.ATuple([ "QUERY_1_1S1R_R__B",(K3.SR.TFloat); "QUERY_1_1T_T__C",(K3.SR.TFloat); "v1",(K3.SR.TFloat) ]),(K3.SR.Tuple([ (K3.SR.Var("QUERY_1_1T_T__C",(K3.SR.TFloat))) ])))),(K3.SR.Slice((K3.SR.OutPC("QUERY_1_1R1T1",[ "QUERY_1_1S1R_R__B",(K3.SR.TFloat); "QUERY_1_1T_T__C",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ "QUERY_1_1S1R_R__B",(K3.SR.TFloat); "QUERY_1_1T_T__C",(K3.SR.TFloat) ],([ "QUERY_1_1S1R_R__B",(K3.SR.Var("QUERY_1_1S1R_R__B",(K3.SR.TFloat))) ]))))))));
K3.SR.IfThenElse((K3.SR.Member((K3.SR.OutPC("QUERY_1_1S1",[ "QUERY_1_1S1R_R__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1S1R_R__B",(K3.SR.TFloat))) ])),(K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1S1",[ "QUERY_1_1S1R_R__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1S1R_R__B",(K3.SR.TFloat))) ],(K3.SR.Apply((K3.SR.Lambda(K3.SR.AVar("current_v",(K3.SR.TFloat)),(K3.SR.Add((K3.SR.Var("current_v",(K3.SR.TFloat))),(K3.SR.Mult((K3.SR.Var("QUERY_1_1S1R_A",(K3.SR.TFloat))),(K3.SR.Const(M3.CFloat(-1.))))))))),(K3.SR.Lookup((K3.SR.OutPC("QUERY_1_1S1",[ "QUERY_1_1S1R_R__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[ (K3.SR.Var("QUERY_1_1S1R_R__B",(K3.SR.TFloat))) ])))))),(K3.SR.PCValueUpdate((K3.SR.OutPC("QUERY_1_1S1",[ "QUERY_1_1S1R_R__B",(K3.SR.TFloat) ],(K3.SR.TFloat))),[  ],[ (K3.SR.Var("QUERY_1_1S1R_R__B",(K3.SR.TFloat))) ],(K3.SR.Add((K3.SR.Mult((K3.SR.Var("QUERY_1_1S1R_A",(K3.SR.TFloat))),(K3.SR.Const(M3.CFloat(-1.))))),(K3.SR.Const(M3.CFloat(0.))))))))
]
in
   test_compile 
      "on_delete_r" ["QUERY_1_1S1R_A";"QUERY_1_1S1R_R__B"]
      on_delete_r

;;
