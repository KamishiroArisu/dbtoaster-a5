######################### COMPILATION PREFS #########################
all: dbtoaster dbtoaster_top

SOURCE = \
	util/Util.ml \
	stages/Common.ml \
	stages/sql/Sql.mli \
	stages/sql/Sql.ml \
	stages/ring/Calculus.mli \
	stages/ring/Calculus.ml \
	stages/ring/Compiler.ml \
	stages/plan/IncrementalPlan.mli \
	stages/plan/IncrementalPlan.ml \

HEADERS =

LEX_SOURCE = stages/sql/Sqllexer.mll
YACC_SOURCE = stages/sql/Sqlparser.mly

SEARCH_PATHS = $(patsubst %,-I %,\
	util \
	stages \
	stages/sql \
	stages/ring \
	stages/plan \
)

LIBS = str unix

UNIT_TESTS = \
	sqlparser \
	calc_translation \
	compiler 

STD_FLAGS = -g
OPT_FLAGS = -ccopt -O3 -nodynlink -unsafe -noassert

BIN_DIR = bin

######################### COMMANDS #########################

OCAMLC     = ocamlc     $(SEARCH_PATHS) \
												$(patsubst %,%.cma,$(LIBS)) \
												$(STD_FLAGS)
OCAMLOPT   = ocamlopt   $(SEARCH_PATHS) \
												$(patsubst %,%.cmxa,$(LIBS)) \
												$(OPT_FLAGS)
OCAMLMKTOP = ocamlmktop $(SEARCH_PATHS) \
												$(patsubst %,%.cma,$(LIBS)) \
												$(STD_FLAGS)
OCAMLDEP   = ocamldep   $(SEARCH_PATHS)
OCAMLYACC  = ocamlyacc
OCAMLLEX   = ocamllex

######################### AUTOGENERATED VARS #########################

include Makefile.deps

GENERATED_SOURCE = \
	$(patsubst %.mll,%.ml,$(LEX_SOURCE)) \
	$(patsubst %.mly,%.ml,$(YACC_SOURCE)) \
	$(patsubst %.mly,%.mli,$(YACC_SOURCE)) \

SOURCE += $(GENERATED_SOURCE)

STD_OBJ = $(patsubst %.ml, %.cmo,$(filter %.ml,$(SOURCE)))
STD_HDR = $(patsubst %.mli,%.cmi,$(filter %.mli,$(SOURCE)))\
				  $(patsubst %.mli,%.cmi,$(filter %.mli,$(HEADERS)))

OPT_OBJ = $(patsubst %.cmo,%.cmx, $(STD_OBJ))
OPT_HDR = $(patsubst %.cmi,%.cmxi,$(STD_HDR))

STD_FLAGS += $(SEARCH_PATHS)
OPT_FLAGS += $(SEARCH_PATHS)

######################### COMPILATION #########################

# the big files
dbtoaster: bin/dbtoaster
bin/dbtoaster: stages/Driver.ml $(OPT_OBJ)
	@echo Linking DBToaster
	@$(OCAMLOPT) -o bin/dbtoaster $(OPT_OBJ) stages/Driver.ml

dbtoaster_top: bin/dbtoaster_top
bin/dbtoaster_top: stages/Driver.ml $(STD_OBJ)
	@echo Generating DBToaster_Top
	@$(OCAMLMKTOP) -o bin/dbtoaster_top $(STD_OBJ)

# basic compilation
$(STD_HDR) : %.cmi : %.mli
	@echo Compiling Header $*
	@$(OCAMLC) -c $<

$(STD_OBJ) : %.cmo : %.ml 
	@echo Compiling $*
	@$(OCAMLC) -c $<

# optimized compilation
$(OPT_HDR) : %.cmxi : %.mli
	@echo Compiling Optimized Header $*
	@$(OCAMLOPT) -c $<

$(OPT_OBJ) : %.cmx : %.ml 
	@echo Compiling Optimized $*
	@$(OCAMLOPT) -c $<

# generated source files
%.ml : %.mly
	@echo Building $*
	@$(OCAMLYACC) $<

%.ml : %.mll
	@echo Building $*
	@$(OCAMLLEX) $<

# generated headers are generated by the process that generates
# the basic source file
$(filter %.mli,$(GENERATED_SOURCE)) : %.mli : %.ml

dep: Makefile.deps
Makefile.deps: $(filter %.ml,$(SOURCE))
	@echo "Computing dependencies"
	@$(OCAMLDEP) $(filter %.ml,$(SOURCE)) > Makefile.deps 

######################### CLEANUP #########################

clean: 
	rm -f $(GENERATED_SOURCE) \
			  $(STD_OBJ) $(STD_HDR) \
			  $(OPT_OBJ) $(OPT_HDR) \
			  $(patsubst %.ml,%.cmi,$(filter %.ml,$(SOURCE))) \
			  $(patsubst %.cmx,%.o,$(OPT_OBJ)) \
			  bin/dbtoaster bin/dbtoaster_top \
				Makefile.deps

.PHONY: dbtoaster dbtoaster_top clean all vars test dep

######################### DEBUGGING #########################

test: 
	@bin/dbt_unit $(SEARCH_PATHS) \
							  $(UNIT_TESTS) \
							  --top      bin/dbtoaster_top \
							  --unit-dir test/unit

vars:
	@echo ==== SOURCE ====
	@echo $(SOURCE)
	@echo $(LEX_SOURCE)
	@echo $(YACC_SOURCE)
	@echo ==== SEARCH_PATHS ====
	@echo $(SEARCH_PATHS)
	@echo ==== STANDARD OBJECTS ====
	@echo $(STD_OBJ)
	@echo $(STD_HDR)

